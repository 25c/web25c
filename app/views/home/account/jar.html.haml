= content_for(:head) do
  = javascript_include_tag "submit-payment"
  :javascript
    window.hasCard = Boolean(#{ !@card_masked_number.blank? });
    window.hasResult = Boolean(#{ !@result.nil? });
    window.setRefillUrl = '#{ j home_set_refill_path }';

.row
  .span12
    %h2.page-header= t('.title') + @user.email
.row
  .span12
    .lead
      %div Your Jar:
      %div
        %b #{@user.balance * 4} 25c's 
        %span ($#{"%.2f" % @user.balance})
%hr
.row
  .span12
    %h3 Refill your tip jar:
    
    %label{:for => "refill-amount"} Refill Amount:
    %select#refill-amount
      - ['5','10','15','20','50','100'].each do |amount|
        - if amount == '20'
          %option{:value => "#{amount}", :selected => "selected"} $#{amount}.00
        - else
          %option{:value => "#{amount}"} $#{amount}.00
    %div.checkbox-container
      %input.checkbox#auto-refill-checkbox{:type => 'checkbox', 
        :checked => @user.auto_refill ? "true" : nil,
        :name => 'auto_refill'} 
        Automatically refill my 25c Jar if balance drops below $5 (20 25c's).
    -if !@card_masked_number.blank?
      #existing-card
        %p
          Card on file:
          %b
            = @card_masked_number
        %form{:action => home_confirm_payment_url, :method => 'post' }
          %input.transaction-amount{:type => 'hidden', :name => 'transaction[amount]'}
          %input.payment-type{:type => 'hidden', :name => 'payment_type', :value => 'existing'}
          %input.btn{:type => 'submit', :value => 'Submit Payment'}
      
      #toggle-card-container
        .btn#toggle-card-button Use a different card

    #new-card.hide
      -if @result
        .errors
          %h4 #{@result.errors.size} error(s):
          - @result.errors.each do |error|
            %p.errors #{error.message}
      = form_for :transaction,
          :params => @result && @result.params[:transaction],
          :errors => @result && @result.errors.for(:transaction),
          :builder => ApplicationHelper::BraintreeFormBuilder,
          :url => Braintree::TransparentRedirect.url,
          :html => {:id => "transaction-form", :autocomplete => "off"} do |f|
        %label{:for => "cardholder_name"} Name on Card:
        %input{:type => 'text', :size => 40, :name => 'transaction[credit_card][cardholder_name]'}
        %div.pull-left
          %label{:for => "number"} Card Number:
          %input#card-number{:type => 'text', :size=>40, 
            :name => 'transaction[credit_card][number]'}
        %label{:for => "CVV"} CVV:
        %input#card-CVV{:type => 'text', :size => 40, :name => 'transaction[credit_card][cvv]'}
        %label{:for => "expiration_date"} Expiration Date:
        %select#card-expiration-month{:name => 'transaction[credit_card][expiration_month]'}
          %option{:selected => "selected", :disabled => "disabled", :value => ""} Month...
          - (1..12).each do |month|
            %option{:value => "#{month}"} #{Date::MONTHNAMES[month]}
        %select#card-expiration-year{:name => 'transaction[credit_card][expiration_year]'}
          %option{:selected => "selected", :disabled => "disabled", :value => ""} Year...
          - (Date.today.year..20.years.from_now.year).each do |year|
            %option{:value => "#{year.to_s()[2,2]}"} #{year.to_s()}
        = hidden_field_tag :tr_data, @bt_data
        %div.checkbox-container
          %input.checkbox{:type => 'checkbox', :checked => 'true', :value => 'true',
            :name => 'transaction[options][store_in_vault_on_success]'}
            Remember credit card for future transactions.
        %input.transaction-amount{:type => 'hidden', :name => 'transaction[amount]'}
        %input.payment-type{:type => 'hidden', :name => 'payment_type', :value => 'new'}
        %input.btn{:type => 'submit', :value => 'Submit Payment'}